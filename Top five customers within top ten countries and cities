WITH top_10_countries_cte(country_id,country, total_revenue) AS
(
SELECT D.country_id, 
   D.country,
   SUM(E.amount) AS total_revenue
FROM customer A
INNER JOIN address B ON A.address_id = B.address_id
INNER JOIN city C ON B.city_id = C.city_id
INNER JOIN country D ON C.country_ID = D.country_ID
INNER JOIN payment E ON A.customer_id = E.customer_id
GROUP BY D.country_id, D.country
ORDER BY total_revenue DESC
LIMIT 10
), 

top_10_cities_cte(country_id,country,city_id,city,total_revenue) AS
(
SELECT D.country_id,
   D.country,
   C.city_id,
   C.city,
   SUM(E.amount) AS total_revenue
FROM customer A
INNER JOIN address B ON A.address_id = B.address_id
INNER JOIN city C ON B.city_id = C.city_id
INNER JOIN country D ON C.country_ID = D.country_ID
INNER JOIN payment E ON A.customer_id = E.customer_id
WHERE D.country IN (SELECT country from top_10_countries_cte)
GROUP BY D.country_id, D.country, C.city_id, C.city
ORDER BY total_revenue DESC
LIMIT 10
)

SELECT  A.customer_id,
A.first_name,
A.last_name,
D.country, 
C.city, 
SUM(E.amount) AS total_revenue
FROM customer A
INNER JOIN address B ON A.address_id = B.address_id
INNER JOIN city C ON B.city_id = C.city_id
INNER JOIN country D ON C.country_ID = D.country_ID
INNER JOIN payment E ON A.customer_id = E.customer_id
WHERE C.city IN (SELECT city from top_10_cities_cte)
GROUP BY A.customer_id, A.first_name, A.last_name, D.country, C.City
ORDER BY SUM(E.amount) DESC
LIMIT 5
